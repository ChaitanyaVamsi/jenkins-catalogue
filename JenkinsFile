pipeline{

  // agent any
  agent{
    node{
      label 'slave'
    }
  }

  environment{
    COURSE = "Jenkins"
    PROJECT = "roboshop"
    COMPONENT = "catalogue"
    appVersion = ""
    ACC_ID = "713169986769"
  }

  options{
    timeout(time:10, unit: 'MINUTES')
    disableConcurrentBuilds()
  }

  stages{
    // need a plugin for this - Pipeline Utility Steps
    stage ('Display Version'){
        steps{
          script{
            def packageJSON = readJSON file: 'package.json'
            appVersion= packageJSON.version // this appVersion is defined in environment
            echo "app version: ${appVersion}"
          }
        }
    }

    stage('install dependencies'){
      steps{
        script{
          sh """
              npm install
          """
        }
      }
    }

    stage('Unit Test'){
      steps{
        script{
          sh """
            npm test
          """
        }
      }
    }
    stage('Build Image'){
      steps{
        script{
           withAWS(region:'us-east-1',credentials:'awsECRCreds') {
            sh """
                    aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${ACC_ID}.dkr.ecr.us-east-1.amazonaws.com
                    docker build -t ${PROJECT}/${COMPONENT}:${appVersion} .
                    docker tag ${PROJECT}/${COMPONENT}:${appVersion} ${ACC_ID}.dkr.ecr.us-east-1.amazonaws.com/${PROJECT}/${COMPONENT}:${appVersion}
                    docker images
                    docker push ${ACC_ID}.dkr.ecr.us-east-1.amazonaws.com/${PROJECT}/${COMPONENT}:${appVersion}
            """
            }

        }
      }
    }


  }
}